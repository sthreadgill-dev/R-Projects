---
title: "MLB Strikeout Averages 1991-2012"
output: flexdashboard::flex_dashboard
runtime: shiny
---

URL for the interactive dashboard: https://o4yk5w-susan-t.shinyapps.io/MLB-Strikeout-Averages-1901-2012/

```{r global, include = FALSE}



library(Lahman)
library(dplyr)
data(Teams)

ave.so <- Teams$SO / Teams$G
year <- Teams$yearID

ave.so.min <- min(ave.so, na.rm = TRUE)
ave.so.max <- max(ave.so, na.rm = TRUE)

league.ave <- tapply(X = ave.so, 
                     INDEX = as.factor(year), 
                     FUN = "mean", 
                     na.rm = TRUE)

league.year <- as.numeric(names(league.ave))


  # REQUIRED ADDITIONAL CODE

      # This line takes the vector of team 
      # averages, 'ave.so', and appends it to 
      # the dataset 'Teams' as a new variable.

  # HOW IT WORKS

      # When you assign values to a non-
      # existent variable by using '$' on an 
      # existing dataset, you create a new, 
      # permanent variable in the dataset.

      # For example:
      # 'dat$new_variable <- some_vector'

      # Dataset 'dat' would now have a new 
      # variable, called 'new_variable', 
      # that contains the values of
      # vector 'some_vector'.

Teams$ave.so <- ave.so

team_list <- Teams %>%
  filter(yearID >= 1900, yearID <= 2012) %>%
  count(name) %>%
  filter(n > 90) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  pull(name) %>%
  as.character() 

```



Column {.sidebar}
-----------------------------------------------------------------------

Select a team to highlight on the graph.

```{r}

selectInput(
  inputId  = "my_team",
  label    = "Select a team:",
  choices  = c("Select Team" = "NULLVALUE", team_list),
  selected = "NULLVALUE"
)

```


**Author:** Susan Threadgill

**Date:**  `r format(Sys.time(), '%B %d, %Y')`


Column
-----------------------------------------------------------------------

### Strikeouts on the Rise

```{r}

renderPlot({

index <- which(Teams$yearID <= 2012 & Teams$yearID >= 1900)

Teams <- Teams[index, ]
  
index <- which(year <= 2012 & year >= 1900)

ave.so <- ave.so[index]
year <- year[index]

index <- which(league.year <= 2012 
               & league.year >= 1900)

league.ave <- league.ave[index]
league.year <- league.year[index]


team.name <- input$my_team                  # 'team.name' takes the name of selected team
                                            # Calls to 'input$' must occur in 'renderPlot({...})'

dat.one.team <- filter(Teams, 
                       name == team.name)   # Filtering to include only selected team

                                            # You now have to use 'dat.one.team' in your
                                            # visualization's code for the "highlighted"
                                            # team trend line
                                            

# --- Add Font Family --- (for Title/Subtitle)
library(showtext)
font_add(family = "Georgia", 
         regular = "georgia.ttf")
showtext_auto()

# --- Margin adjustments --- (later used to adjust x & y axis label positions)
par(mar=c(5.1, 4.1, 4.1, 5), 
    xaxs="i",  # Make the x-axis fit exactly to the range given instead of 
               # adding extra space on the sides.
    mgp=c(1.6,0.1,0), # Controls spacing for axis labels and ticks (distance 
                      # of axis labels aka 'Year', distance of tick mark 
                      # numbers, position of the axis line)
    plt=c(0.08, 0.95, 0.15, 0.85), # Shrinks the plot area a little inside the 
                                   # margins, numbers are percentages (left, 
                                   # right, bottom, top)
    cex = 0.80)  # global text scaling for dashboard

# --- Create Plot ---
plot.new()
plot.window(xlim = c(1900, 2012.5),   # Specify x-axis limits 
            ylim = c(ave.so.min, 
                     ave.so.max))    # Specify y-axis limits

# --- Axes ---

# X-axis with ticks every 10 years
y0 <- par("usr")[3] + 0.1 # grabs the lowest y value in plot window and shifts up
segments(1900, y0, 2014, y0, lwd = 1)

axis(side = 1, 
     at = seq(1900, 2010, by = 10),
     labels = FALSE,
     cex.axis = 1.2,
     tck = -0.005,
     lwd = 0.5,
     line = -0.25)

# Date labels and location adjustments
dates_labels <- seq(1900, 2010, by = 10)
mtext(text = dates_labels,
      side = 1,
      at = dates_labels,
      padj = -.9,
      adj = -0.01,
      cex = .9)  

# Y-axis
axis(side = 4,
     at = 0:9,
     labels = FALSE,
     lwd = 0,
     las = 2,
     line = 0.5)

# Add Y labels except 8
for (val in 0:9) {
  if (val != 8) {   # skip 8
    text(x = par("usr")[2] + 1.5,   # grabs the maximum x-value and moves the 
                                    # values into the right margin
         y = val,
         labels = val,
         cex = 1.3,   
         font = 1,
         col = "gray65",
         xpd = TRUE,
         adj = 0)
  }
}

# --- Background Dotted Line Grid ---
gray_shades <- c("gray80","gray85","gray85","gray90",
                 "gray90","gray90","gray90","gray85","gray80")

# Coordinates where line gap for legend title start/end
legend_gap_x0 <- 1900
legend_gap_x1 <- 1938.5

for (i in 1:9) {
  if (i == 9) { # special case for line at y = 9 
    # left part of dotted line
    segments(x0 = 1900, 
             y0 = i, 
             x1 = legend_gap_x0, 
             y1 = i, 
             lty = "dotted", 
             col = gray_shades[i], 
             lwd = 1.5)
    
    # right part of dotted line
    segments(x0 = legend_gap_x1, 
             y0 = i, 
             x1 = 2013, 
             y1 = i, 
             lty = "dotted", 
             col = gray_shades[i], 
             lwd = 1.5)
    
  } else if (i == 8 && !is.null(input$my_team) && input$my_team != "NULLVALUE"){ 
    # new special case for y=8 when a team legend is showing
    team_label_width <- strwidth(input$my_team, cex = 1.3, font = 1)  # match legend text size
    gap_start <- 1900
    gap_end   <- 1900 + strwidth("_______") + team_label_width + strwidth("      ")  # line + text padding
    segments(1900, i, gap_start, i, lty = "dotted", col = gray_shades[i], lwd = 1.5)
    segments(gap_end, i, 2013, i, lty = "dotted", col = gray_shades[i], lwd = 1.5)

  } else {
    # normal full dotted line
    segments(x0 = 1900, 
             y0 = i, 
             x1 = 2013, 
             y1 = i, 
             lty = "dotted", 
             col = gray_shades[i], 
             lwd = 1.5)
  }
}

# Plotting strike outs and specifying point color, size, and shape.
points(x = year[year > 1900], 
       y = ave.so[year > 1900],
       col = "gray90",   # Color
       pch = 16,         # Shape
       cex = 0.75)       # Size

# --- Functions for creating custom call outs and legend ---

# Bottom-stacked call out (1924 style)
add_point_callout_bottom <- function(x, y, number_text, mid_text, bottom_text,
                                     color = "#0F618A") {
  points(x, y, pch = 1, cex = 1.7, lwd = 1, col = "#333333")
  text(x, y - 0.26, number_text, 
       cex = 2.8, col = color, font = 2, adj = c(0.5, 1))   
  text(x, y - 0.75, mid_text, 
       cex = 1.3, font = 2, adj = c(0.5, 1))                
  text(x, y - 1, bottom_text, 
       cex = 1.3, font = 2, adj = c(0.5, 1))                
}

# Top-stacked call out (2012 style)
add_point_callout_top <- function(x, y, number_text, mid_text, top_text,
                                  color = "#0F618A") {
  points(x, y, pch = 1, cex = 1.7, lwd = 1, col = "#333333", xpd = TRUE)
  text(x, y + 1, top_text, 
       cex = 1.3, font = 2, adj = c(0.5, 0), xpd = TRUE)    
  text(x, y + 0.7, mid_text, 
       cex = 1.3, font = 2, adj = c(0.5, 0), xpd = TRUE)    
  text(x, y + 0.2, number_text, 
       cex = 2.8, font = 2, col = color, 
       adj = c(0.5, 0), xpd = TRUE)                         
}

# Event call out for stacked labels with same styling
add_event_callout_below <- function(x_year, y_from, y_to, label, 
                                    cex = 1.2, col_line = "gray85",  
                                    col_text = "gray55",
                                    line_spacing = 0.3) {
  # Draw vertical line
  segments(x0 = x_year, y0 = y_from, x1 = x_year, y1 = y_to, 
           col = col_line, lwd = 1)
  
  # Split into multiple lines as character vectors
  lines <- strsplit(label, "\n")[[1]]
  
  # Put the text just below the line's bottom
  for (i in seq_along(lines)) {
    text(x_year, y_from - 0.1 - (i - 1) * line_spacing, 
         labels = lines[i], 
         cex = cex, 
         col = col_text,
         adj = c(0.5, 1), xpd = TRUE)
  }
}

add_event_callout_above <- function(x_year, y_from, y_to, label, 
                                    cex = 1.2, col_line = "gray70",  
                                    col_text = "gray55",
                                    line_spacing = 0.3) {
  # Draw the vertical line
  segments(x0 = x_year, y0 = y_from, x1 = x_year, y1 = y_to, 
           col = col_line, lwd = 1)
  
  # Split into multiple lines
  lines <- strsplit(label, "\n")[[1]]
  
  # Put the text just above the lineâ€™s top
  for (i in seq_along(lines)) {
    text(x_year, y_to + 0.2 + (length(lines) - i) * line_spacing,  
         labels = lines[i], 
         cex = cex, 
         col = col_text,
         adj = c(0.5, 0),  
         xpd = TRUE)
  }
}

# Custom legend
add_custom_legend <- function(x, y, label, col_line, col_text) {
  # Line + dots
  x0 <- x
  x1 <- x0 + strwidth("_____")
  segments(x0, y, x1, y, col = col_line, lwd = 2) 
  points(c(x0, x1), 
         c(y, y), 
         pch = 16, 
         col = col_line, 
         cex = 0.7)     
  
  # Label to the right of the line
  text(x1 + strwidth("      "), 
       y, 
       labels = label,
       adj = 0, 
       col = col_text, 
       cex = 1.3,  
       font = 1)
}



# --- League Average Line ---
accurate_trend_line <- league.year >= 1901 & league.year <= 2012
league.ave <- league.ave[accurate_trend_line]
league.year <- league.year[accurate_trend_line]

lines(x = league.year, 
      y = league.ave,
      col = "#0F618A",
      lwd = 1.5)

points(x = league.year,
       y = league.ave,
       col = adjustcolor("#0F618A",alpha.f=0.7),
       pch = 16, 
       cex = 1)  

# --- Title, Subtitle, Legend ----
title(main = "Strikeouts on the Rise",
      line = -.7,
      adj = 0,
      family = "Georgia",
      font = 2,
      cex.main = 2.8)  # was 3.3

mtext("There were more strikeouts in 2012 than at any other time in major league history.",
      side = 3, 
      line = -2.4, 
      adj = 0,
      family = "Georgia",
      font = 1,
      col = "#333333",
      cex = 1.5)  # was 1.8

# --- Selected Team Average Line ---
if (!is.null(input$my_team) && input$my_team != "NULLVALUE") {
  team.name <- input$my_team

  # Filter selected team
  dat.one.team <- Teams %>%
    filter(name == team.name, !is.na(ave.so)) %>% # <--- prevent line gaps from missing data/NAs
    select(yearID, ave.so)

  # Expand to all years 1900â€“2012
  full_years <- data.frame(yearID = 1901:2012)
  dat.one.team.full <- full_years %>%
    left_join(dat.one.team, by = "yearID") %>%
     filter(!is.na(ave.so))   # <--- drop NAs after join

  # Draw continuous line & points
  lines(x = dat.one.team.full$yearID,
        y = dat.one.team.full$ave.so,
        col = adjustcolor("#f2a20d", alpha.f=0.6), 
        lwd = 1.25)
  points(x = dat.one.team.full$yearID,
         y = dat.one.team.full$ave.so,
         col = adjustcolor("#f2a20d", alpha.f=0.8), 
         pch = 20, 
         cex = 1.5)

# Add Legend for ONLY when a Team is selected
  add_custom_legend(x = 1900.5, y = 8,
                    label = team.name,
                    col_line = "#f2a20d",
                    col_text = "#b87e14")
}
  
# Add Legend for League Average
add_custom_legend(x = 1900.5, y = 8.5, 
                  label = "League Average", 
                  col_line = "#0F618A",
                  col_text = "#217fae")


# Legend title (2-part style)
title_y <- 8.95
text(1900, 
     title_y, 
     "Strikeouts per game per team ",
     adj = 0, 
     font = 2, 
     cex = 1.5) 

x_offset <- strwidth("Strikeouts per game per team ",
                     font = 2, 
                     cex = 1.5)

text(1900 + x_offset, 
     title_y, 
     " (by batters)",
     col = "gray60", 
     adj = 0, 
     font = 1, 
     cex = 1.5)  

# --- Call Outs ---
y1924 <- league.ave[league.year == 1924]
y2012 <- league.ave[league.year == 2012]

add_point_callout_bottom(1924, y1924, "2.7", "League average", "1924")
add_point_callout_top(2012, y2012, "7.5", "League average", "2012")

add_event_callout_below(1917, 1.35, 3.48, "U.S. enters\nWorld War I.")
add_event_callout_below(1946, 1.85, 3.97, "Players return\nfrom World War II.")
add_event_callout_below(1963, 2.85, 5.8, "Strike zone enlarged\nfrom 1963â€“1968.")
add_event_callout_above(1969, 5.83, 7.95, 
                        "Pitching had become so dominant\nin the 1960s that the mound\nwas lowered in 1969.")
add_event_callout_below(1973, 1.85, 5.2, "Designated hitter\nrule took effect.")
add_event_callout_below(2008, 3.85, 6.8, "Mitchell report\non steroids.")
  
}, width = 960, height = 768, res = 120)


```

